<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>アドオン翻訳支援パック生成ツール</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<style>
body { font-family: sans-serif; padding: 20px; }
#downloadLink { font-size: 18px; color: blue; }
</style>
</head>
<body>

<h2>アドオン翻訳支援パック生成ツール</h2>

<p>マイクラ統合版アドオン（.mcaddon / .mcpack）を選択してください：</p>
<input type="file" id="addonInput" accept=".mcaddon,.mcpack,.zip">

<button id="buildBtn" style="margin-left:10px;">翻訳パックを生成</button>

<div id="status" style="margin-top:20px;color:#444;"></div>

<script>
let pokemonDict = {};
let manifestTemplate = {};

async function loadExternalFiles() {
    try {
        const dictRes = await fetch("./pokemonDict.json");
        pokemonDict = await dictRes.json();

        const maniRes = await fetch("./manifestTemplate.json");
        manifestTemplate = await maniRes.json();

        console.log("辞書・テンプレート読み込み完了！");
    } catch (err) {
        console.error("辞書 or テンプレート読み込み失敗", err);
        alert("辞書またはテンプレートが読み込めませんでした。ファイルを同じフォルダに置いてね。");
    }
}
loadExternalFiles();

function uuid() {
    return crypto.randomUUID();
}

async function extractLangFiles(mainZip) {
    const langFiles = [];
    
    async function loadPack(zip) {
        zip.forEach((relativePath, file) => {
            if (!file.dir && /texts\/.*\.lang$/.test(relativePath)) {
                langFiles.push({ path: relativePath, file: file });
            }
        });
        const packPromises = [];
        zip.forEach((relativePath, file) => {
            if (relativePath.endsWith(".mcpack") || relativePath.endsWith(".zip")) {
                packPromises.push(file.async("blob").then(blob => JSZip.loadAsync(blob)));
            }
        });
        const innerZips = await Promise.all(packPromises);
        for (const inner of innerZips) {
            await loadPack(inner);
        }
    }
    
    await loadPack(mainZip);
    return langFiles;
}

function translateLang(text) {
    // CRLFをLFに統一
    const lines = text.replace(/\r\n/g, "\n").split("\n");
    const out = [];

    for (let line of lines) {
        const eqIndex = line.indexOf("=");
        if (eqIndex <= 0) {
            out.push(line);
            continue;
        }
        const key = line.substring(0, eqIndex);
        let value = line.substring(eqIndex + 1);

        for (const src in pokemonDict) {
            const pattern = new RegExp(src.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), "g");
            value = value.replace(pattern, pokemonDict[src]);
        }

        out.push(`${key}=${value}`);
    }

    return out.join("\n");
}

function createDownloadLink(blob) {
    const url = URL.createObjectURL(blob);
    let old = document.getElementById("downloadLink");
    if (old) old.remove();

    const a = document.createElement("a");
    a.id = "downloadLink";
    a.href = url;
    a.download = "TranslationPK.mcpack";
    a.textContent = "★ダウンロードが始まらない場合は、ここから翻訳パックを保存してください";
    a.style.display = "block";
    a.style.marginTop = "20px";

    document.body.appendChild(a);
    setTimeout(() => a.click(), 300);
}

document.getElementById("buildBtn").onclick = async () => {
    const input = document.getElementById("addonInput");
    if (!input.files.length) {
        alert("アドオンファイルを選択してください！");
        return;
    }
    const addonFile = input.files[0];
    document.getElementById("status").textContent = "読み込み中…";

    try {
        const buffer = await addonFile.arrayBuffer();
        const zip = await JSZip.loadAsync(buffer);
        document.getElementById("status").textContent = "langファイル捜索…";

        const langFiles = await extractLangFiles(zip);
        if (langFiles.length === 0) {
            document.getElementById("status").textContent = "言語ファイルが見つかりませんでした…";
            return;
        }

        // 1個目のlangファイルを翻訳
        const langInfo = langFiles[0];
        let origText = await langInfo.file.async("string");
        // BOM除去
        origText = origText.charCodeAt(0) === 0xFEFF ? origText.slice(1) : origText;
        const translated = translateLang(origText);

        const outZip = new JSZip();
        const manifest = {
            ...manifestTemplate,
            header: { ...manifestTemplate.header, uuid: uuid() },
            modules: manifestTemplate.modules.map(m => ({ ...m, uuid: uuid() }))
        };
        outZip.file("manifest.json", JSON.stringify(manifest, null, 2));
        // ここが重要！binary:false を指定して全行保存
        outZip.file("texts/ja_JP.lang", translated, { binary: false });

        const blob = await outZip.generateAsync({ type: "blob" });
        createDownloadLink(blob);
        document.getElementById("status").textContent = "生成完了！";

    } catch (err) {
        console.error(err);
        document.getElementById("status").textContent = "解析に失敗しました…";
    }
};
</script>

</body>
</html>