<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ポケモン翻訳パック生成ツール</title>

<style>
  body {
    font-family: sans-serif;
    padding: 20px;
  }
  h2 {
    margin-top: 25px;
  }
  .box {
    border: 1px solid #ccc;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
  }
</style>
</head>

<body>
<h1>翻訳パック生成ツール</h1>
<p>対象のアドオン(.mcaddon / .mcpack / zip) を読み込むと、翻訳済みの ja_JP.lang を生成します。</p>

<div class="box">
  <h2>① 辞書データ読み込み</h2>
  <button id="loadDictBtn">辞書を読み込む</button>
  <p id="dictStatus">未読み込み</p>
</div>

<div class="box">
  <h2>② アドオンを読み込む</h2>
  <input type="file" id="addonFile" accept=".mcaddon,.mcpack,.zip" />
  <p id="addonStatus">未選択</p>
</div>

<button id="buildBtn" disabled>翻訳パックを作成</button>

<!-- ダウンロードリンク生成位置 -->
<div id="downloadArea"></div>

<script>
// ----------------------
// 辞書データ読み込み
// ----------------------
let dictionary = {};

document.getElementById("loadDictBtn").onclick = async () => {
  try {
    const res = await fetch("./pokemonDict.json");
    dictionary = await res.json();
    document.getElementById("dictStatus").textContent = "辞書ロード完了 ✔";
    enableBuildButton();
  } catch (e) {
    document.getElementById("dictStatus").textContent = "辞書ファイルの読み込みに失敗…";
  }
};


// ----------------------
// アドオンファイル選択
// ----------------------
let addonFile = null;

document.getElementById("addonFile").onchange = (ev) => {
  addonFile = ev.target.files[0];
  if (addonFile) {
    document.getElementById("addonStatus").textContent = addonFile.name + " を読み込みます";
    enableBuildButton();
  }
};


// ----------------------
// 両方揃ったらボタン解放
// ----------------------
function enableBuildButton() {
  if (addonFile && Object.keys(dictionary).length > 0) {
    document.getElementById("buildBtn").disabled = false;
  }
}


// ----------------------
// ZIP 読み込み＆翻訳
// ----------------------
document.getElementById("buildBtn").onclick = async () => {
  if (!addonFile) return;

  const buffer = await addonFile.arrayBuffer();
  const zip = await JSZip.loadAsync(buffer);

  // 言語ファイル探し
  const langFiles = Object.keys(zip.files).filter(
    f => f.includes("texts/") && f.endsWith(".lang")
  );

  if (langFiles.length === 0) {
    alert("言語ファイルが見つからなかったよ…");
    return;
  }

  // とりあえず最初の言語ファイルを翻訳する
  const langName = langFiles[0];
  const origText = await zip.files[langName].async("string");

  const translated = translateLang(origText);

  // 新ZIP生成
  const newZip = new JSZip();
  newZip.file("texts/ja_JP.lang", translated);

  const outBlob = await newZip.generateAsync({ type: "blob" });
  createDownloadLink(outBlob);
};


// ----------------------
// 翻訳関数（値だけ翻訳）
// ----------------------
function translateLang(text) {
  const lines = text.split("\n");
  const out = [];

  for (let line of lines) {
    const eq = line.indexOf("=");
    if (eq === -1) {
      out.push(line);
      continue;
    }

    const key = line.slice(0, eq).trim();
    const val = line.slice(eq + 1).trim();

    const translatedVal = dictionary[val] || val;
    out.push(`${key}=${translatedVal}`);
  }

  return out.join("\n");
}


// ----------------------
// スマホ対応ダウンロードリンク生成
// ----------------------
function createDownloadLink(blob) {
  const url = URL.createObjectURL(blob);

  // 古いリンク消す
  const area = document.getElementById("downloadArea");
  area.innerHTML = "";

  const link = document.createElement("a");
  link.href = url;
  link.download = "Pokemon_JP_Translation.mcpack";
  link.textContent = "翻訳パックをダウンロード";
  link.style.display = "block";
  link.style.marginTop = "20px";

  area.appendChild(link);

  // スマホ対応の自動クリック
  setTimeout(() => link.click(), 200);
}

</script>

<!-- JSZip CDN -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

</body>
</html>
